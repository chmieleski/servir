services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: servir
      POSTGRES_USER: servir
      POSTGRES_PASSWORD: servir
    ports:
      - '5432:5432'
    volumes:
      - servir-postgres-data:/var/lib/postgresql/data

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    depends_on:
      - postgres
    environment:
      NODE_ENV: production
      PORT: 3000
      API_PREFIX: api/v1
      API_DOCS_PATH: api/docs
      APP_VERSION: 0.0.0
      NEXT_PUBLIC_API_BASE_URL: http://localhost:3001/api/v1
      DATABASE_URL: postgresql://servir:servir@postgres:5432/servir?schema=public
      CLERK_PUBLISHABLE_KEY: pk_test_replace_me
      CLERK_SECRET_KEY: sk_test_replace_me
      CLERK_AUTHORIZED_PARTIES: http://localhost:3000,http://localhost:3001
      AUTH_E2E_TEST_MODE: 'false'
      AUTH_E2E_TEST_SECRET: servir-e2e-secret
      CLERK_WEBHOOK_SIGNING_SECRET: whsec_replace_me
      BILLING_ENFORCEMENT_ENABLED: 'true'
      BILLING_ALLOWED_PATHS: /api/v1/health,/api/docs,/api/v1/auth/me,/api/v1/org-requests,/api/v1/platform,/api/v1/organizations,/api/v1/billing,/api/v1/internal/webhooks/clerk
      BILLING_ACTIVE_STATUSES: active,trialing
      BILLING_INACTIVE_GRACE_DAYS: 0
    ports:
      - '3001:3000'

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    depends_on:
      - api
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE_URL: http://api:3000/api/v1
    ports:
      - '3000:3000'

volumes:
  servir-postgres-data:
