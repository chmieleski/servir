name: Infra Plan

on:
  pull_request:
    paths:
      - 'infra/terraform/**'
      - 'infracost-usage.yml'
      - '.github/workflows/infra-plan.yml'

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  AWS_REGION: us-east-1
  TF_DIR: infra/terraform/api
  TF_IN_AUTOMATION: true
  TF_VAR_aws_region: us-east-1
  TF_VAR_project_name: servir
  TF_VAR_environment: prod
  TF_VAR_api_domain: ${{ vars.API_DOMAIN || 'api.example.com' }}
  TF_VAR_letsencrypt_email: ${{ vars.LETSENCRYPT_EMAIL || 'ops@example.com' }}
  TF_VAR_api_prefix: ${{ vars.API_PREFIX }}
  TF_VAR_api_docs_enabled: ${{ vars.API_DOCS_ENABLED || 'true' }}
  TF_VAR_api_docs_path: ${{ vars.API_DOCS_PATH || 'docs' }}
  TF_VAR_api_cors_origin: ${{ vars.API_CORS_ORIGIN || '*' }}
  TF_VAR_app_version: ${{ github.sha }}

jobs:
  terraform-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform format check
        run: terraform fmt -check -recursive infra/terraform

      - name: Terraform init (no backend)
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -backend=false -input=false

      - name: Terraform validate
        working-directory: ${{ env.TF_DIR }}
        run: terraform validate

  terraform-plan:
    runs-on: ubuntu-latest
    needs: terraform-check
    if: ${{ secrets.AWS_ROLE_ARN != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate Terraform backend config vars
        env:
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_STATE_LOCK_TABLE: ${{ vars.TF_STATE_LOCK_TABLE }}
        run: |
          if [ -z "${TF_STATE_BUCKET}" ] || [ -z "${TF_STATE_LOCK_TABLE}" ]; then
            echo "::error::Missing required repository variables TF_STATE_BUCKET or TF_STATE_LOCK_TABLE."
            exit 1
          fi

      - name: Terraform init
        working-directory: ${{ env.TF_DIR }}
        env:
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_STATE_LOCK_TABLE: ${{ vars.TF_STATE_LOCK_TABLE }}
          TF_STATE_KEY: ${{ vars.TF_STATE_KEY || 'api/prod/terraform.tfstate' }}
        run: |
          terraform init -input=false \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${TF_STATE_KEY}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${TF_STATE_LOCK_TABLE}" \
            -backend-config="encrypt=true"

      - name: Terraform plan
        working-directory: ${{ env.TF_DIR }}
        run: terraform plan -input=false -lock=false -no-color

  infracost:
    runs-on: ubuntu-latest
    needs: terraform-check
    if: ${{ secrets.INFRACOST_API_KEY != '' }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate baseline estimate
        run: |
          infracost breakdown \
            --path="${TF_DIR}" \
            --usage-file=infracost-usage.yml \
            --format=json \
            --out-file=/tmp/infracost-base.json

      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Generate PR cost estimate and diff
        run: |
          infracost breakdown \
            --path="${TF_DIR}" \
            --usage-file=infracost-usage.yml \
            --format=json \
            --out-file=/tmp/infracost-pr.json

          infracost diff \
            --path="${TF_DIR}" \
            --usage-file=infracost-usage.yml \
            --compare-to=/tmp/infracost-base.json \
            --format=json \
            --out-file=/tmp/infracost-diff.json

      - name: Post Infracost comment
        run: |
          infracost comment github \
            --path=/tmp/infracost-diff.json \
            --repo="${GITHUB_REPOSITORY}" \
            --github-token="${{ github.token }}" \
            --pull-request="${{ github.event.pull_request.number }}" \
            --behavior=update \
            --show-skipped

      - name: Enforce projected monthly budget cap ($25)
        run: |
          set -euo pipefail
          MONTHLY_COST=$(jq -r '
            ((.totalMonthlyCost // null) | tonumber?) //
            ((.projects // [])
              | map((.breakdown.totalMonthlyCost // null) | tonumber?)
              | map(select(. != null))
              | add // 0)
          ' /tmp/infracost-pr.json)

          CAP=25
          echo "Projected monthly cost: ${MONTHLY_COST} USD"
          echo "Budget cap: ${CAP} USD"

          if awk "BEGIN {exit !(${MONTHLY_COST} > ${CAP})}"; then
            echo "::error::Projected monthly cost ${MONTHLY_COST} USD exceeds cap ${CAP} USD."
            exit 1
          fi
